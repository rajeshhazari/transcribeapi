import groovy.json.JsonSlurper;

def readAppInfoFromJson() {
    def workspacePath = pwd()
    def slurper = new JsonSlurper()
    def json = slurper.parseText(new File("${WORKSPACE}/response.json").text)
    def status = json.status
    return status
}

pipeline {
    agent any
    tools {
        maven 'maven3'
    }
    environment{
        def JAVA_OPTS='-Dspring.profiles.active=dev -Dlogging.level.org.springframework=DEBUG   -agentlib:jdwp=transport=dt_socket,server=y,suspend=n '
        def idstring = UUID.randomUUID().toString();
        id = "tmp-${UUID.randomUUID()}"




    }
    parameters {
        string(name: 'BRANCH_NAME', defaultValue: 'branch1', description: 'Branch Name')
        string(name: 'environment', defaultValue: 'dev', description: 'Environment profile for sping app')
        choice(name: 'DEPLOY_TO', choices: ['dev', 'qa', 'prod'], description: 'select and environement for deploying.')
    }

    stages {
        stage ('prepare environment'){
            steps{
                println("idString:: "+idstring +" id:: "+id)
                sh '''
                
                   #mkdir -pv /opt/apps/  /opt/test/
                   ls -lrth /opt/apps/  /opt/
                    echo "PATH = ${PATH}"
                    echo "M2_HOME = ${M2_HOME}"
                    
                    #mvn install:install-file -Dfile=/home/devuser/.m2/repository/edu/cmu/sphinx/sphinx4-core/5prealpha-SNAPSHOT/sphinx4-core-5prealpha-SNAPSHOT.jar -DartifactId=sphinx4-core -DgroupId=edu.cmu.sphinx -Dversion=5prealpha-SNAPSHOT -Dpackaging=jar
                    #mvn install:install-file -Dfile=/home/devuser/.m2/repository/edu/cmu/sphinx/sphinx4-data/5prealpha-SNAPSHOT/sphinx4-data-5prealpha-SNAPSHOT.jar -DartifactId=sphinx4-data -DgroupId=edu.cmu.sphinx -Dversion=5prealpha-SNAPSHOT -Dpackaging=jar
                    
                    
                   '''
            }
        }
        stage('Checkout') {
            steps{
                checkout scm
                sh 'ls -lrth .'
            }
        }
        stage('Build') {
            steps {
                echo "Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
                sh '''
                id -a 
                   mvn  -U -DskipTests clean install 
                   
                '''

            }
        }
        stage('Unit-test') {
            steps {
                echo 'Testing..'
                //sh 'mvn -B test package'
            }
        }
        stage('Deploy') {
            when {
                environment name: 'DEPLOY_TO', value: 'production'
            }
            steps {
                echo 'Deploying'
            }
        }
        stage('Deploy-devappserver'){
            when{

                environment name: 'DEPLOY_TO', value: 'dev'
                //currentBuild.result == null || currentBuild.result == 'SUCCESS'

            }
            steps{
                script{

                    def workspacePath=pwd();

                    sh '''
                            pwd
                            ls -lrth 
                            cp target/*.jar app.jar
                            mv app.jar /opt/apps/
                            curl -k -X POST https://localhost:8585/api/v1/shutdown || true
                            nohup java -jar ${JAVA_OPTS} /opt/apps/app.jar   >/dev/null 2>&1 &
                             curl -k --retry-delay 10 --retry 5 https://devappserver:8585/api/v1/actuator/info -o ${WORKSPACE}/response.json
                                http_response=$(curl -k -s -o response.json -w "%{http_code}" https://devappserver:8585/api/v1/actuator/health )
                               echo "response code: $http_response"
                               if [ $http_response != "200" ]; then
                                    # handle error
                                    exit 1
                                else
                                    echo "Server returned:"
                                    cat response.json    
                                fi
                            '''

                    println("workspacePath:: status "+readAppInfoFromJson())
                }




            }
        }
        stage('Deploy-prod') {
            when {

                environment name: 'DEPLOY_TO', value: 'production'
                //currentBuild.result == null || currentBuild.result == 'SUCCESS'

            }
            steps {
                println("Deploying to "+environment)
            }
        }


    }
    post {
        always {
            println("Do something line sanity tests like acuatator healtcheck")
        }
        failure {
            //mail to: transcribeappuser@yahoo.com, subject: 'The Pipeline failed '
            println(" file failed ")
        }
    }





}
